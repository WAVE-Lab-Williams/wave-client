<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WAVE Client Example</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .log {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .error {
      color: #dc3545;
    }
    .success {
      color: #28a745;
    }
    .info {
      color: #17a2b8;
    }
    .jspsych-section {
      border-top: 2px solid #eee;
      margin-top: 30px;
      padding-top: 30px;
    }
    .stimulus {
      display: inline-block;
      padding: 20px 40px;
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      font-size: 24px;
      margin: 20px 0;
      cursor: pointer;
      user-select: none;
    }
    .stimulus:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WAVE JavaScript Client Example</h1>
    <p>This example demonstrates how to use the WAVE JavaScript client for experiment data logging.</p>
    
    <!-- URL Authentication Info -->
    <div class="info" style="background-color: #e7f3ff; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
      <h3>üîê URL-Based Authentication</h3>
      <p><strong>Recommended:</strong> Add your API key to the URL for automatic authentication:</p>
      <p><code>https://yoursite.com/experiment.html?key=exp_abc123&participant=P001</code></p>
      <p><strong>Current URL Status:</strong> <span id="urlStatus">Checking...</span></p>
      <p>You can also manually enter an API key below (overrides URL parameter).</p>
    </div>

    <!-- Configuration Section -->
    <div class="form-group">
      <label for="apiKey">API Key (Optional - overrides URL parameter):</label>
      <input type="password" id="apiKey" placeholder="Leave empty to use URL parameter">
    </div>

    <div class="form-group">
      <label for="baseUrl">Base URL:</label>
      <input type="url" id="baseUrl" value="http://localhost:8000" placeholder="WAVE API base URL">
    </div>

    <div class="form-group">
      <label for="experimentId">Experiment ID (UUID):</label>
      <input type="text" id="experimentId" placeholder="e.g. 550e8400-e29b-41d4-a716-446655440000">
    </div>

    <div class="form-group">
      <label for="participantId">Participant ID:</label>
      <input type="text" id="participantId" placeholder="e.g. SUBJ-2024-001">
    </div>

    <!-- Basic Data Logging Section -->
    <h2>Basic Data Logging</h2>
    <div class="form-group">
      <label for="experimentData">Experiment Data (JSON):</label>
      <textarea id="experimentData" rows="6" placeholder='{"reaction_time": 1.234, "accuracy": 0.85, "difficulty_level": 2}'></textarea>
    </div>

    <button onclick="logExperimentData()">Log Experiment Data</button>
    <button onclick="testConnection()">Test Connection</button>

    <!-- jsPsych Integration Section -->
    <div class="jspsych-section">
      <h2>jsPsych Integration Demo</h2>
      <p>Click the stimulus below to simulate a jsPsych trial:</p>
      
      <div class="stimulus" onclick="simulateJsPsychTrial()">CLICK ME</div>
      
      <button onclick="logJsPsychData()" id="jsPsychLogBtn" disabled>Log jsPsych Trial Data</button>
    </div>

    <!-- Log Output -->
    <div class="log" id="logOutput">Ready...\n</div>
  </div>

  <!-- Load WAVE Client -->
  <script type="module">
    import WaveClient from '../dist/wave-client.esm.js';
    
    // Make WaveClient available globally for the example
    window.WaveClient = WaveClient;
    window.client = null;
    window.lastJsPsychTrial = null;

    // Extract API key from URL parameters
    window.getApiKeyFromUrl = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      return urlParams.get('key') || hashParams.get('key');
    };

    // Check URL status on load
    window.checkUrlStatus = function() {
      const urlKey = getApiKeyFromUrl();
      const statusElement = document.getElementById('urlStatus');
      
      if (urlKey) {
        statusElement.innerHTML = `<span class="success">‚úì API key found in URL (${urlKey.substring(0, 8)}...)</span>`;
      } else {
        statusElement.innerHTML = `<span class="error">‚úó No API key in URL - add ?key=your_api_key</span>`;
      }
    };

    // Initialize client (URL parameter or manual input)
    window.initializeClient = function() {
      const manualApiKey = document.getElementById('apiKey').value.trim();
      const urlApiKey = getApiKeyFromUrl();
      const apiKey = manualApiKey || urlApiKey; // Manual input overrides URL
      const baseUrl = document.getElementById('baseUrl').value;
      
      if (!apiKey) {
        log('Please provide an API key via URL parameter (?key=...) or enter manually', 'error');
        return null;
      }

      try {
        const options = {
          baseUrl: baseUrl,
          timeout: 30000, // 30 seconds for demo
          retries: 3
        };

        if (manualApiKey) {
          options.apiKey = manualApiKey;
          log('Using manually entered API key (overrides URL)', 'info');
        } else {
          log('Using API key from URL parameter', 'info');
        }

        window.client = new WaveClient(options);
        log('Client initialized successfully', 'success');
        return window.client;
      } catch (error) {
        log(`Failed to initialize client: ${error.message}`, 'error');
        return null;
      }
    };

    // Log function
    window.log = function(message, type = 'info') {
      const logOutput = document.getElementById('logOutput');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      logOutput.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logOutput.scrollTop = logOutput.scrollHeight;
    };

    // Test connection
    window.testConnection = async function() {
      const client = initializeClient();
      if (!client) return;

      try {
        log('Testing connection...', 'info');
        const health = await client.getHealth();
        log(`‚úì Health check passed: ${JSON.stringify(health)}`, 'success');
        
        const version = await client.getVersion();
        log(`‚úì Version info: ${JSON.stringify(version)}`, 'success');
        
      } catch (error) {
        log(`‚úó Connection test failed: ${error.message}`, 'error');
      }
    };

    // Log experiment data
    window.logExperimentData = async function() {
      const client = initializeClient();
      if (!client) return;

      const experimentId = document.getElementById('experimentId').value;
      const participantId = document.getElementById('participantId').value;
      const experimentDataText = document.getElementById('experimentData').value;

      if (!experimentId || !participantId || !experimentDataText) {
        log('Please fill in all required fields', 'error');
        return;
      }

      try {
        const experimentData = JSON.parse(experimentDataText);
        log(`Logging data for experiment ${experimentId}...`, 'info');
        
        const result = await client.logExperimentData(experimentId, participantId, experimentData);
        log(`‚úì Data logged successfully: ${JSON.stringify(result, null, 2)}`, 'success');
        
      } catch (error) {
        if (error.name === 'SyntaxError') {
          log('‚úó Invalid JSON in experiment data', 'error');
        } else {
          log(`‚úó Failed to log data: ${error.message}`, 'error');
        }
      }
    };

    // Simulate jsPsych trial
    window.simulateJsPsychTrial = function() {
      const startTime = performance.now();
      
      setTimeout(() => {
        const endTime = performance.now();
        const reactionTime = endTime - startTime;
        
        // Simulate jsPsych trial data
        window.lastJsPsychTrial = {
          rt: reactionTime,
          response: 'correct',
          correct: true,
          stimulus: 'blue_square',
          trial_type: 'simple-reaction-time',
          trial_index: Math.floor(Math.random() * 100),
          time_elapsed: Date.now(),
          internal_node_id: '0.0-0.0'
        };

        log(`jsPsych trial completed: RT = ${reactionTime.toFixed(2)}ms`, 'info');
        document.getElementById('jsPsychLogBtn').disabled = false;
        
      }, Math.random() * 100 + 50); // Random delay to simulate processing
    };

    // Log jsPsych data
    window.logJsPsychData = async function() {
      const client = initializeClient();
      if (!client || !window.lastJsPsychTrial) return;

      const experimentId = document.getElementById('experimentId').value;
      const participantId = document.getElementById('participantId').value;

      if (!experimentId || !participantId) {
        log('Please fill in experiment ID and participant ID', 'error');
        return;
      }

      try {
        // Convert jsPsych data to WAVE format
        const waveData = WaveClient.fromJsPsychData(window.lastJsPsychTrial);
        log(`Converted jsPsych data: ${JSON.stringify(waveData, null, 2)}`, 'info');
        
        // Log the data
        const result = await client.logExperimentData(experimentId, participantId, waveData);
        log(`‚úì jsPsych data logged successfully: ${JSON.stringify(result, null, 2)}`, 'success');
        
        // Reset
        document.getElementById('jsPsychLogBtn').disabled = true;
        window.lastJsPsychTrial = null;
        
      } catch (error) {
        log(`‚úó Failed to log jsPsych data: ${error.message}`, 'error');
      }
    };

    // Auto-fill some example data and check URL status
    document.addEventListener('DOMContentLoaded', function() {
      // Check URL for API key
      checkUrlStatus();
      
      // Auto-fill participant ID from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const participantFromUrl = urlParams.get('participant');
      if (participantFromUrl) {
        document.getElementById('participantId').value = participantFromUrl;
        log(`Participant ID auto-filled from URL: ${participantFromUrl}`, 'info');
      }
      
      // Auto-fill example experiment data
      const experimentDataTextarea = document.getElementById('experimentData');
      experimentDataTextarea.value = JSON.stringify({
        reaction_time: 1.234,
        accuracy: 0.85,
        difficulty_level: 2,
        stimulus_type: 'visual',
        response: 'correct'
      }, null, 2);
      
      log('Example loaded. Try adding ?key=your_api_key&participant=P001 to the URL', 'info');
    });
  </script>

  <!-- Fallback for browsers that don't support ES modules -->
  <script nomodule>
    document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h1>Browser Not Supported</h1><p>This example requires a modern browser with ES6 module support.</p></div>';
  </script>
</body>
</html>