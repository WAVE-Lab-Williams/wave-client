<!DOCTYPE html>
<html>

<head>
    <title>Simple WAVE Experiment Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }

        #target {
            background-color: #e0e0e0;
            border: 2px solid #ccc;
            padding: 20px 40px;
            font-size: 18px;
            cursor: pointer;
            margin: 20px;
        }

        #status {
            margin: 20px;
            font-size: 16px;
            min-height: 20px;
        }

        .info {
            background-color: #f0f8ff;
            border: 1px solid #ccc;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: left;
        }

        .error {
            background-color: #ffe0e0;
            border: 1px solid #ff9999;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <h1>Simple Reaction Time Experiment</h1>

    <div id="url-setup" class="info">
        <strong>URL Setup Required:</strong><br>
        This experiment needs URL parameters:<br>
        • <code>key=your_api_key</code> - Your WAVE API key<br>
        • <code>experiment_id=experiment_uuid</code> - The experiment ID<br>
        • <code>participant_id=participant_name</code> - Unique participant identifier<br>
        <br>
        <strong>Example:</strong><br>
        <code>file:///path/to/file.html?key=your_key&experiment_id=123&participant_id=P001</code>
    </div>

    <div id="experiment" style="display: none;">
        <p>Click the button when it turns red!</p>
        <button id="target" onclick="recordResponse()">Click Me</button>
        <div id="status">Get ready...</div>
    </div>

    <script type="module">
        import { WaveClient } from 'https://cdn.jsdelivr.net/gh/WAVE-Lab-Williams/wave-client@v1.0.0/javascript/dist/wave-client.esm.js';

        // Configuration - get from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const API_KEY = urlParams.get('key');
        const EXPERIMENT_ID = urlParams.get('experiment_id');
        const PARTICIPANT_ID = urlParams.get('participant_id');

        console.log('🔍 Full URL:', window.location.href);
        console.log('🔍 Search params:', window.location.search);
        console.log('🔍 URL Params object:', urlParams.toString());
        console.log('API Key:', API_KEY ? 'Found (length: ' + API_KEY.length + ')' : 'Missing');
        console.log('Experiment ID:', EXPERIMENT_ID || 'Missing');
        console.log('Participant ID:', PARTICIPANT_ID || 'Missing');

        // Check if all required parameters are present
        if (!API_KEY || !EXPERIMENT_ID || !PARTICIPANT_ID) {
            console.error('Missing required URL parameters');
            document.getElementById('url-setup').style.display = 'block';
            document.getElementById('experiment').style.display = 'none';
        } else {
            // Hide setup instructions and show experiment
            document.getElementById('url-setup').style.display = 'none';
            document.getElementById('experiment').style.display = 'block';
        }

        let client;
        let trialNumber = 1;
        let startTime;

        // Initialize the client with API key
        try {
            if (API_KEY) {
                client = new WaveClient({
                    apiKey: API_KEY,
                    baseUrl: 'http://localhost:8000'
                });
                console.log('✓ WAVE client initialized with API key');

                // Test connection
                client.getHealth().then(health => {
                    console.log('✓ Backend connection:', health);
                }).catch(error => {
                    console.warn('⚠ Backend connection failed:', error.message);
                    showError('Warning: Could not connect to backend. Data logging may fail.');
                });
            }

        } catch (error) {
            console.error('✗ Failed to initialize WAVE client:', error.message);
            showError(`Setup Error: ${error.message}`);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = message;
            document.body.insertBefore(errorDiv, document.getElementById('experiment'));
        }

        function startTrial() {
            const button = document.getElementById('target');
            const status = document.getElementById('status');

            button.style.backgroundColor = '#e0e0e0';
            status.textContent = 'Get ready...';

            // Random delay before showing target
            setTimeout(() => {
                button.style.backgroundColor = 'red';
                startTime = performance.now();
                status.textContent = 'Click now!';
            }, Math.random() * 3000 + 1000);
        }

        window.recordResponse = async function () {
            if (!startTime) return; // Prevent clicks before stimulus

            const reactionTime = (performance.now() - startTime) / 1000; // Convert to seconds
            startTime = null; // Prevent multiple clicks

            try {
                // Log data to WAVE backend
                const response = await client.logExperimentData(EXPERIMENT_ID, PARTICIPANT_ID, {
                    trial_number: trialNumber,
                    reaction_time: reactionTime,
                    stimulus_color: "red",  // Simple red stimulus
                    response_key: "click",  // Mouse click response
                    accuracy: true,  // Assume correct for simple click task
                    timestamp: new Date().toISOString(),
                    user_agent: navigator.userAgent
                });

                console.log('✓ Data logged successfully:', response);

                document.getElementById('status').textContent =
                    `Trial ${trialNumber} completed! RT: ${reactionTime.toFixed(3)}s`;

                trialNumber++;

                // Reset for next trial
                setTimeout(() => {
                    if (trialNumber <= 5) { // Limit to 5 trials for demo
                        startTrial();
                    } else {
                        document.getElementById('status').textContent =
                            'Experiment completed! Check console for logged data.';
                        document.getElementById('target').style.display = 'none';
                    }
                }, 2000);

            } catch (error) {
                console.error('✗ Failed to log data:', error);
                document.getElementById('status').textContent =
                    `Error logging data: ${error.message}`;
            }
        }

        // Start first trial if everything is set up
        if (API_KEY && EXPERIMENT_ID && PARTICIPANT_ID && client) {
            console.log('🚀 Starting experiment...');
            startTrial();
        } else {
            console.log('❌ Cannot start experiment - missing parameters or client not initialized');
        }
    </script>
</body>

</html>