<!DOCTYPE html>
<html>

<head>
    <title>Simple WAVE Experiment Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }

        #target {
            background-color: #e0e0e0;
            border: 2px solid #ccc;
            padding: 20px 40px;
            font-size: 18px;
            cursor: pointer;
            margin: 20px;
        }

        #status {
            margin: 20px;
            font-size: 16px;
            min-height: 20px;
        }

        .info {
            background-color: #f0f8ff;
            border: 1px solid #ccc;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: left;
        }

        .error {
            background-color: #ffe0e0;
            border: 1px solid #ff9999;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <h1>Simple Reaction Time Experiment</h1>

    <div class="info">
        <strong>URL Setup Required:</strong><br>
        This experiment needs an API key in the URL. Add <code>?key=your_api_key</code> to the URL.<br>
        Example: <code>file:///path/to/this/file.html?key=exp_abc123</code>
    </div>

    <div id="experiment" style="display: none;">
        <p>Click the button when it turns red!</p>
        <button id="target" onclick="recordResponse()">Click Me</button>
        <div id="status">Get ready...</div>
    </div>

    <script type="module">
        import { WaveClient } from 'https://cdn.jsdelivr.net/gh/WAVE-Lab-Williams/wave-client@latest/javascript/dist/wave-client.esm.js';

        // Configuration - update these for your experiment
        const EXPERIMENT_ID = 123;  // Replace with your experiment ID
        const PARTICIPANT_ID = 'demo-participant';  // Replace with actual participant ID

        let client;
        let trialNumber = 1;
        let startTime;

        // Initialize the client
        try {
            client = new WaveClient();
            console.log('✓ WAVE client initialized');

            // Show the experiment
            document.getElementById('experiment').style.display = 'block';

            // Test connection
            client.getHealth().then(health => {
                console.log('✓ Backend connection:', health);
            }).catch(error => {
                console.warn('⚠ Backend connection failed:', error.message);
                showError('Warning: Could not connect to backend. Data logging may fail.');
            });

        } catch (error) {
            console.error('✗ Failed to initialize WAVE client:', error.message);
            showError(`Setup Error: ${error.message}`);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = message;
            document.body.insertBefore(errorDiv, document.getElementById('experiment'));
        }

        function startTrial() {
            const button = document.getElementById('target');
            const status = document.getElementById('status');

            button.style.backgroundColor = '#e0e0e0';
            status.textContent = 'Get ready...';

            // Random delay before showing target
            setTimeout(() => {
                button.style.backgroundColor = 'red';
                startTime = performance.now();
                status.textContent = 'Click now!';
            }, Math.random() * 3000 + 1000);
        }

        window.recordResponse = async function () {
            if (!startTime) return; // Prevent clicks before stimulus

            const reactionTime = (performance.now() - startTime) / 1000; // Convert to seconds
            startTime = null; // Prevent multiple clicks

            try {
                // Log data to WAVE backend
                const response = await client.logExperimentData(EXPERIMENT_ID, PARTICIPANT_ID, {
                    reaction_time: reactionTime,
                    trial_number: trialNumber,
                    timestamp: new Date().toISOString()
                });

                console.log('✓ Data logged successfully:', response);

                document.getElementById('status').textContent =
                    `Trial ${trialNumber} completed! RT: ${reactionTime.toFixed(3)}s`;

                trialNumber++;

                // Reset for next trial
                setTimeout(() => {
                    if (trialNumber <= 5) { // Limit to 5 trials for demo
                        startTrial();
                    } else {
                        document.getElementById('status').textContent =
                            'Experiment completed! Check console for logged data.';
                        document.getElementById('target').style.display = 'none';
                    }
                }, 2000);

            } catch (error) {
                console.error('✗ Failed to log data:', error);
                document.getElementById('status').textContent =
                    `Error logging data: ${error.message}`;
            }
        }

        // Start first trial
        if (client) {
            startTrial();
        }
    </script>
</body>

</html>