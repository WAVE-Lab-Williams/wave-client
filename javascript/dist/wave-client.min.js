!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WaveClient={})}(this,function(e){"use strict";class t extends Error{constructor(e,t=null,r=null,s=void 0){super(e),this.name="WaveClientError",this.statusCode=t,this.detail=r,void 0!==s&&(this.retryAfter=s)}}class r extends t{constructor(e,t){super(e,400,t),this.name="ValidationError"}}class s extends t{constructor(e,t){super(e,401,t),this.name="AuthenticationError"}}class a extends t{constructor(e,t){super(e,403,t),this.name="AuthorizationError"}}class n extends t{constructor(e,t){super(e,404,t),this.name="NotFoundError"}}class i extends t{constructor(e,t,r){super(e,429,t,r),this.name="RateLimitError"}}class o extends t{constructor(e,t,r){super(e,t,r),this.name="ServerError"}}function c(e,c){const{status:l}=e,u=c?.detail||e.statusText||"Unknown error",h=c?.detail;switch(l){case 400:return new r(u,h);case 401:return new s(u,h);case 403:return new a(u,h);case 404:return new n(u,h);case 429:{const t=function(e){if(!e)return;const t=parseInt(e,10);if(!isNaN(t))return 1e3*t;const r=new Date(e);if(!isNaN(r.getTime()))return Math.max(0,r.getTime()-Date.now());return 5e3}(e.headers.get("Retry-After"));return new i(u,h,t)}case 500:case 502:case 503:case 504:return new o(u,l,h);default:return new t(u,l,h)}}e.AuthenticationError=s,e.AuthorizationError=a,e.NotFoundError=n,e.RateLimitError=i,e.ServerError=o,e.ValidationError=r,e.WaveClientError=t,e.default=class{constructor(e={}){if(this.apiKey=e.apiKey||this._getApiKeyFromUrl(),this.baseUrl=e.baseUrl||this._getEnvVar("WAVE_API_URL")||"http://localhost:8000",this.timeout=e.timeout||3e4,this.maxRetries=e.retries||5,this.baseDelay=e.baseDelay||1e3,this.maxDelay=e.maxDelay||3e4,this.clientVersion="1.0.0",!this.apiKey)throw new s('API key is required. Provide apiKey option or include "key" parameter in URL.');this.baseUrl=this.baseUrl.replace(/\/$/,"")}async logExperimentData(e,t,s){if(!e)throw new r("experimentId is required");if(!t)throw new r("participantId is required");if(!s||"object"!=typeof s||Array.isArray(s))throw new r("data must be a non-empty object");const a={participant_id:t,data:s},n=`/api/v1/experiment-data/${e}/data/`;return await this._makeRequest("POST",n,a)}async getHealth(){return await this._makeRequest("GET","/health")}async getVersion(){return await this._makeRequest("GET","/version")}setBaseUrl(e){if(!e)throw new r("Base URL cannot be empty");this.baseUrl=e.replace(/\/$/,"")}async _makeRequest(e,r,s=null,a=1){const n=`${this.baseUrl}${r}`,i={method:e,headers:{Authorization:`Bearer ${this.apiKey}`,"X-WAVE-Client-Version":this.clientVersion,"Content-Type":"application/json"}};if("undefined"!=typeof AbortSignal&&AbortSignal.timeout)i.signal=AbortSignal.timeout(this.timeout);else if("undefined"!=typeof AbortController){const e=new AbortController;i.signal=e.signal,setTimeout(()=>e.abort(),this.timeout)}!s||"POST"!==e&&"PUT"!==e||(i.body=JSON.stringify(s));try{const t=await fetch(n,i);if(!t.ok){let n;try{n=await t.json()}catch{n={detail:t.statusText}}const i=c(t,n);if(this._shouldRetry(i,a)){const t=this._calculateDelay(a,i.retryAfter);return console.warn(`Request failed (${i.name}), retrying in ${t}ms (attempt ${a}/${this.maxRetries})`),await this._sleep(t),await this._makeRequest(e,r,s,a+1)}throw i}return await t.json()}catch(n){if("AbortError"===n.name){const n=new t(`Request timeout after ${this.timeout}ms`);if(this._shouldRetry(n,a)){const t=this._calculateDelay(a);return console.warn(`Request timeout, retrying in ${t}ms (attempt ${a}/${this.maxRetries})`),await this._sleep(t),await this._makeRequest(e,r,s,a+1)}throw n}if(n instanceof t)throw n;const i=new t(`Network error: ${n.message}`);if(this._shouldRetry(i,a)){const t=this._calculateDelay(a);return console.warn(`Network error, retrying in ${t}ms (attempt ${a}/${this.maxRetries})`),await this._sleep(t),await this._makeRequest(e,r,s,a+1)}throw i}}_shouldRetry(e,c){return!(c>this.maxRetries)&&(!(e instanceof r||e instanceof s||e instanceof a||e instanceof n)&&(e instanceof i||e instanceof o||"AbortError"===e.name||e instanceof t))}_calculateDelay(e,t=null){if(t)return Math.min(t,this.maxDelay);const r=this.baseDelay*Math.pow(2,e-1),s=1e3*Math.random();return Math.min(r+s,this.maxDelay)}_sleep(e){return new Promise(t=>setTimeout(t,e))}_getApiKeyFromUrl(){const e="undefined"!=typeof window?window:global.window,t="undefined"!=typeof URLSearchParams?URLSearchParams:global.URLSearchParams;if(!e||!t)return null;try{const r=new t(e.location.search).get("key");if(r)return r;const s=new t(e.location.hash.substring(1)).get("key");return s||null}catch(e){return console.warn("Failed to extract API key from URL:",e.message),null}}_getEnvVar(e){if("undefined"!=typeof process&&process.env)return process.env[e]}},Object.defineProperty(e,"__esModule",{value:!0})});//# sourceMappingURL=wave-client.min.js.map
